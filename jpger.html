<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NOFNWAY | JPEGer</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root { --brand: #3498db; --dark: #2c3e50; --bg: #0f172a; --border: #334155; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: #f8fafc; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .navbar { background: var(--dark); padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; color: white; flex-shrink: 0; z-index: 2000; border-bottom: 1px solid var(--border); }
        .brand { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1.5rem; text-decoration: none; color: white; }
        .brand span { color: var(--brand); }
        .back-link { color: #aaa; text-decoration: none; font-size: 0.8rem; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; }
        .workspace { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        canvas { border: 1px solid var(--border); background: white; width: 100%; cursor: crosshair; }
        .canvas-container { position: relative; margin-bottom: 2rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        #ghostContainer { position: absolute; pointer-events: none; z-index: 1000; display: none; line-height: 1; }
        #reticle { position: absolute; width: 8px; height: 8px; background: var(--brand); border-radius: 50%; border: 1px solid white; transform: translate(-50%, -50%); }
        #actualGhostText { position: absolute; color: black; font-family: Arial; white-space: pre; left: 10px; bottom: 5px; }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="index.html" class="brand">NO<span>FN</span>WAY</a>
    <div class="flex gap-4">
        <button onclick="undoLastStamp()" class="text-[10px] font-bold border border-gray-600 px-2 py-1 rounded">UNDO (Ctrl+Z)</button>
        <button onclick="downloadAll()" class="bg-blue-600 px-3 py-1 rounded text-xs font-bold uppercase">Save JPEGs</button>
        <a href="index.html" class="back-link">EXIT</a>
    </div>
</nav>

<div class="bg-slate-800 border-b border-slate-700 p-3 flex flex-wrap gap-4 items-center justify-center sticky top-0 z-[1500]">
    <input type="text" id="liveInput" placeholder="Stamp Text..." class="bg-slate-950 border border-slate-600 p-2 rounded text-sm w-40 text-white outline-none focus:border-blue-400">
    <div class="flex bg-slate-950 rounded p-1 border border-slate-700">
        <button onclick="setMode('text')" id="btnText" class="px-3 py-1 rounded bg-blue-600 font-bold text-xs">TXT</button>
        <button onclick="setMode('check')" id="btnCheck" class="px-3 py-1 rounded font-bold text-xs hover:bg-slate-800">✓</button>
        <button onclick="setMode('x')" id="btnX" class="px-3 py-1 rounded font-bold text-xs hover:bg-slate-800">X</button>
    </div>
    <div class="flex items-center gap-2">
        <span class="text-[10px] uppercase font-bold text-slate-500">Font</span>
        <input type="range" id="fontSize" min="12" max="100" value="36" class="w-16">
    </div>
    <div class="flex items-center gap-2">
        <span class="text-[10px] uppercase font-bold text-slate-500">Zoom</span>
        <input type="range" id="viewZoom" min="30" max="100" value="70" class="w-16">
    </div>
    <button onclick="clearSession()" class="text-red-400 text-[10px] uppercase font-bold underline">Wipe</button>
</div>

<main class="workspace" id="main-ws">
    <div id="setup" class="w-full max-w-xl p-20 border-4 border-dashed border-slate-700 rounded-2xl text-center cursor-pointer hover:border-blue-500 transition-all">
        <p class="font-black text-slate-500 uppercase tracking-tighter text-xl">Drag PDF Here</p>
        <input type="file" id="fileInput" class="hidden" accept="application/pdf">
    </div>
    <div id="pdf-view" class="w-full flex flex-col items-center"></div>
</main>

<div id="ghostContainer"><div id="reticle"></div><span id="actualGhostText"></span></div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    const fileInput = document.getElementById('fileInput'), setup = document.getElementById('setup'), liveInput = document.getElementById('liveInput'), fontSizeSlider = document.getElementById('fontSize'), viewZoomSlider = document.getElementById('viewZoom'), ghostContainer = document.getElementById('ghostContainer'), ghostTextSpan = document.getElementById('actualGhostText'), pdfView = document.getElementById('pdf-view');
    let pageCanvases = [], history = [], currentMode = 'text';

    setup.onclick = () => fileInput.click();
    fileInput.onchange = (e) => loadPdf(e.target.files[0]);
    window.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undoLastStamp(); } if (document.activeElement !== liveInput) { if (e.key === '1') setMode('text'); if (e.key === '2') setMode('check'); if (e.key === '3') setMode('x'); } });
    viewZoomSlider.oninput = () => { document.querySelectorAll('.canvas-container').forEach(c => c.style.width = `${viewZoomSlider.value}%`); };
    liveInput.oninput = () => { if(currentMode === 'text') ghostTextSpan.innerText = liveInput.value; };

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('button[id^="btn"]').forEach(b => b.classList.remove('bg-blue-600'));
        if(mode === 'text') { document.getElementById('btnText').classList.add('bg-blue-600'); ghostTextSpan.innerText = liveInput.value; }
        else if(mode === 'check') { document.getElementById('btnCheck').classList.add('bg-blue-600'); ghostTextSpan.innerText = "✓"; }
        else if(mode === 'x') { document.getElementById('btnX').classList.add('bg-blue-600'); ghostTextSpan.innerText = "X"; }
    }

    async function loadPdf(file) {
        if (!file) return;
        setup.classList.add('hidden');
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2.5 });
            const canvas = document.createElement('canvas');
            canvas.id = `page-${i}`;
            canvas.width = viewport.width; canvas.height = viewport.height;
            const ctx = canvas.getContext('2d');
            await page.render({canvasContext: ctx, viewport}).promise;
            const saved = localStorage.getItem(`jpeger-p${i}`);
            if (saved) { const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0); img.src = saved; }
            canvas.onmouseenter = () => ghostContainer.style.display = 'block';
            canvas.onmouseleave = () => ghostContainer.style.display = 'none';
            canvas.onmousemove = (e) => { ghostContainer.style.left = `${e.pageX}px`; ghostContainer.style.top = `${e.pageY}px`; ghostTextSpan.style.fontSize = `${fontSizeSlider.value * (viewZoomSlider.value / 100)}px`; };
            canvas.onclick = (e) => { const rect = canvas.getBoundingClientRect(); const x = (e.clientX - rect.left) * (canvas.width / rect.width); const y = (e.clientY - rect.top) * (canvas.height / rect.height); saveState(canvas); stamp(ctx, x, y, canvas); };
            const container = document.createElement('div');
            container.className = "canvas-container"; container.style.width = `${viewZoomSlider.value}%`;
            container.appendChild(canvas); pdfView.appendChild(container); pageCanvases.push(canvas);
        }
    }

    function stamp(ctx, x, y, canvas) {
        let val = (currentMode === 'text') ? liveInput.value : (currentMode === 'check' ? "✓" : "X");
        if (!val) return;
        ctx.font = `${fontSizeSlider.value}px Arial`; ctx.fillStyle = "black"; ctx.fillText(val, x, y);
        persistPage(canvas);
    }

    function saveState(canvas) {
        const ctx = canvas.getContext('2d');
        history.push({ canvas: canvas, data: ctx.getImageData(0, 0, canvas.width, canvas.height) });
        if (history.length > 30) history.shift();
    }

    function undoLastStamp() {
        const last = history.pop();
        if (last) { last.canvas.getContext('2d').putImageData(last.data, 0, 0); persistPage(last.canvas); }
    }

    function persistPage(canvas) {
        const id = canvas.id.split('-').pop();
        localStorage.setItem(`jpeger-p${id}`, canvas.toDataURL('image/jpeg', 0.8));
    }

    function clearSession() { if(confirm("Wipe stamps?")) { localStorage.clear(); location.reload(); } }

    function downloadAll() {
        pageCanvases.forEach((canvas, index) => {
            const link = document.createElement('a');
            link.download = `Page_${index + 1}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();
        });
    }
</script>
</body>
</html>
